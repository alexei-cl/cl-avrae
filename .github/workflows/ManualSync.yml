name: Sync to Avrae (M)

on:
  #push:
  #  branches: [ main ]
  workflow_dispatch:  # Allow manual trigger for full sync
    inputs:
      sync_all:
        description: 'Sync all files (not just changed)'
        required: false
        type: boolean
        default: false

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Get all changed files (push only)
      if: github.event_name == 'push'
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          HB Items/**
          HB Spells/**
          **/*.alias
    
    - name: Get all alias files (manual dispatch)
      if: github.event_name == 'workflow_dispatch'
      id: all-files
      run: |
        # Find all .alias files
        files=$(find . -name "*.alias" -type f)
        # Convert newlines to spaces for the output
        files_list=$(echo "$files" | tr '\n' ' ')
        echo "files=$files_list" >> $GITHUB_OUTPUT
        echo "any_changed=true" >> $GITHUB_OUTPUT
    
    - name: Set up Python
      if: (github.event_name == 'push' && steps.changed-files.outputs.any_changed == 'true') || github.event_name == 'workflow_dispatch'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      if: (github.event_name == 'push' && steps.changed-files.outputs.any_changed == 'true') || github.event_name == 'workflow_dispatch'
      run: |
        pip install -r requirements.txt
    
    - name: Sync Homebrew
      if: (github.event_name == 'push' && steps.changed-files.outputs.any_changed == 'true') || github.event_name == 'workflow_dispatch'
      env:
        AVRAE_TOKEN: ${{ secrets.AVRAE_JWT }}
        CHANGED_FILES: ${{ github.event_name == 'push' && steps.changed-files.outputs.all_changed_files || steps.all-files.outputs.files }}
        PACK_ID: ${{ secrets.PACK_ID }}
        TOME_ID: ${{ secrets.TOME_ID }}
        MAINTENANCE_WEBHOOK: ${{ secrets.MAINTENANCE_WEBHOOK }}
        SYNC_ALL: ${{ github.event_name == 'workflow_dispatch' }}
        REBUILD_PACK: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        python avrae_sync.py